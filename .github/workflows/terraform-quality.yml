name: "Terraform Quality"

on:
    workflow_call:
        inputs:
            terraform_version:
                type: string
                default: "1.9.8"
            working_directory:
                type: string
                default: "."
        outputs:
            fmt_outcome:
                description: "Format check result"
                value: ${{ jobs.quality.outputs.fmt_outcome }}
            validate_outcome:
                description: "Validate result"
                value: ${{ jobs.quality.outputs.validate_outcome }}

jobs:
    quality:
        name: Quality Checks
        runs-on: ubuntu-latest
        outputs:
            fmt_outcome: ${{ steps.fmt.outcome }}
            validate_outcome: ${{ steps.validate.outcome }}
        steps:
            - name: Checkout
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
              with:
                  terraform_version: ${{ inputs.terraform_version }}

            - name: Format Check
              id: fmt
              working-directory: ${{ inputs.working_directory }}
              run: terraform fmt -check -recursive -diff -no-color
              continue-on-error: true

            - name: Initialize (Local Backend)
              working-directory: ${{ inputs.working_directory }}
              run: terraform init -backend=false -input=false -no-color

            - name: Validate
              id: validate
              working-directory: ${{ inputs.working_directory }}
              run: terraform validate -no-color

            - name: TFLint Setup
              uses: terraform-linters/setup-tflint@19a52fbac37dacb22a09518e4ef6ee234f2d4987 # v4.0.0
              with:
                  tflint_version: v0.53.0

            - name: TFLint Init
              run: tflint --init
              env:
                  GITHUB_TOKEN: ${{ github.token }}

            - name: TFLint Run
              id: lint
              working-directory: ${{ inputs.working_directory }}
              run: tflint --recursive --format=compact --no-color
              continue-on-error: true

            - name: Quality Summary
              if: always()
              run: |
                  cat >> $GITHUB_STEP_SUMMARY << 'EOF'
                  ## Terraform Quality Checks

                  | Check | Status |
                  |-------|--------|
                  | Format | ${{ steps.fmt.outcome == 'success' && '✅ Pass' || '❌ Fail' }} |
                  | Validate | ${{ steps.validate.outcome == 'success' && '✅ Pass' || '❌ Fail' }} |
                  | Lint | ${{ steps.lint.outcome == 'success' && '✅ Pass' || '⚠️ Warnings' }} |
                  EOF

            - name: Fail on Format Error
              if: steps.fmt.outcome == 'failure'
              run: |
                  echo "::error::Terraform formatting check failed. Run 'terraform fmt -recursive'"
                  exit 1
