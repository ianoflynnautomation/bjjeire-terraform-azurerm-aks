name: "Terraform Apply"

on:
    workflow_call:
        inputs:
            environment:
                type: string
                required: true
            terraform_version:
                type: string
                default: "1.9.8"
            working_directory:
                type: string
                default: "."
            plan_artifact:
                type: string
                required: true
                description: "Name of the plan artifact to download"
        secrets:
            AZURE_CLIENT_ID:
                required: true
            AZURE_TENANT_ID:
                required: true
            AZURE_SUBSCRIPTION_ID:
                required: true
            TF_VAR_github_token:
                required: false
            TF_VAR_grafana_admin_password:
                required: false
        outputs:
            apply_outcome:
                description: "Apply outcome"
                value: ${{ jobs.apply.outputs.outcome }}

permissions:
    id-token: write
    contents: read

jobs:
    apply:
        name: Apply (${{ inputs.environment }})
        runs-on: ubuntu-latest
        environment:
            name: ${{ inputs.environment }}
            url: https://portal.azure.com
        outputs:
            outcome: ${{ steps.apply.outcome }}
        concurrency:
            group: terraform-apply-${{ inputs.environment }}
            cancel-in-progress: false
        env:
            TF_VAR_github_token: ${{ secrets.TF_VAR_github_token }}
            TF_VAR_grafana_admin_password: ${{ secrets.TF_VAR_grafana_admin_password }}
        steps:
            - name: Checkout
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

            - name: Download Plan Artifact
              uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
              with:
                  name: ${{ inputs.plan_artifact }}
                  path: ${{ inputs.working_directory }}

            - name: Setup Terraform & Azure
              uses: ./.github/actions/terraform-setup
              with:
                  terraform_version: ${{ inputs.terraform_version }}
                  azure_client_id: ${{ secrets.AZURE_CLIENT_ID }}
                  azure_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
                  azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
                  working_directory: ${{ inputs.working_directory }}
                  backend_config_file: environments/${{ inputs.environment }}/backend.hcl

            - name: Terraform Apply
              id: apply
              working-directory: ${{ inputs.working_directory }}
              run: |
                  terraform apply \
                    -auto-approve \
                    -no-color \
                    -input=false \
                    tfplan-${{ inputs.environment }}

            - name: Output Summary
              if: always()
              working-directory: ${{ inputs.working_directory }}
              run: |
                  cat >> $GITHUB_STEP_SUMMARY << EOF
                  ## Terraform Apply: \`${{ inputs.environment }}\`

                  **Status:** ${{ steps.apply.outcome == 'success' && '✅ Success' || '❌ Failed' }}
                  **Commit:** \`${{ github.sha }}\`
                  **Actor:** @${{ github.actor }}

                  EOF

                  if [ "${{ steps.apply.outcome }}" == "success" ]; then
                    echo "### Outputs" >> $GITHUB_STEP_SUMMARY
                    echo '```json' >> $GITHUB_STEP_SUMMARY
                    terraform output -json | jq 'to_entries | map(select(.value.sensitive != true)) | from_entries' >> $GITHUB_STEP_SUMMARY
                    echo '```' >> $GITHUB_STEP_SUMMARY
                  fi
