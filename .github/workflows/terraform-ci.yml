name: "Terraform CI"

on:
    workflow_dispatch:
        # pull_request:
        #     branches: [main]
        #     paths:
        #         - "**.tf"
        #         - "**.tfvars"
        #         - "modules/**"
        #         - ".github/workflows/terraform-*.yml"
        #         - ".github/actions/**"

permissions:
    id-token: write
    contents: read
    pull-requests: write
    security-events: write

concurrency:
    group: terraform-ci-${{ github.head_ref || github.ref }}
    cancel-in-progress: true

env:
    TF_VERSION: "1.9.8"

jobs:
    quality:
        name: Quality
        uses: ./.github/workflows/terraform-quality.yml
        with:
            terraform_version: "1.9.8"

    security:
        name: Security
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.2

            - name: Checkov Scan
              uses: bridgecrewio/checkov-action@v12
              with:
                  directory: .
                  framework: terraform
                  output_format: github_failed_only,sarif
                  output_file_path: results.md,results.sarif
                  soft_fail: true
                  skip_check: CKV_AZURE_35,CKV_AZURE_4
                  download_external_modules: true

            - name: Upload SARIF
              if: always()
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: results.sarif
              continue-on-error: true

    changes:
        name: Detect Changes
        runs-on: ubuntu-latest
        outputs:
            dev: ${{ steps.filter.outputs.dev }}
            staging: ${{ steps.filter.outputs.staging }}
            prod: ${{ steps.filter.outputs.prod }}
            any_env: ${{ steps.filter.outputs.dev == 'true' || steps.filter.outputs.staging == 'true' || steps.filter.outputs.prod == 'true' }}
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.2

            - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
              id: filter
              with:
                  filters: |
                      dev:
                        - 'environments/dev/**'
                        - 'modules/**'
                        - '*.tf'
                      staging:
                        - 'environments/staging/**'
                        - 'modules/**'
                        - '*.tf'
                      prod:
                        - 'environments/prod/**'
                        - 'modules/**'
                        - '*.tf'

    plan-dev:
        name: Plan Dev
        needs: [quality, changes]
        if: needs.changes.outputs.dev == 'true'
        uses: ./.github/workflows/terraform-plan.yml
        with:
            environment: dev
            terraform_version: "1.9.8"
        secrets: inherit

    plan-staging:
        name: Plan Staging
        needs: [quality, changes]
        if: needs.changes.outputs.staging == 'true'
        uses: ./.github/workflows/terraform-plan.yml
        with:
            environment: staging
            terraform_version: "1.9.8"
        secrets: inherit

    plan-prod:
        name: Plan Prod
        needs: [quality, security, changes]
        if: needs.changes.outputs.prod == 'true'
        uses: ./.github/workflows/terraform-plan.yml
        with:
            environment: prod
            terraform_version: "1.9.8"
        secrets: inherit

    summary:
        name: PR Summary
        needs: [quality, security, changes, plan-dev, plan-staging, plan-prod]
        if: always()
        runs-on: ubuntu-latest
        steps:
            - name: Generate Summary
              run: |
                  cat >> $GITHUB_STEP_SUMMARY << 'EOF'
                  ## Terraform PR Validation Summary

                  | Stage | Status |
                  |-------|--------|
                  | Quality | ${{ needs.quality.result == 'success' && '✅' || '❌' }} |
                  | Security | ${{ needs.security.result == 'success' && '✅' || '⚠️' }} |
                  | Plan (dev) | ${{ needs.plan-dev.result == 'success' && '✅' || needs.plan-dev.result == 'skipped' && '⏭️' || '❌' }} |
                  | Plan (staging) | ${{ needs.plan-staging.result == 'success' && '✅' || needs.plan-staging.result == 'skipped' && '⏭️' || '❌' }} |
                  | Plan (prod) | ${{ needs.plan-prod.result == 'success' && '✅' || needs.plan-prod.result == 'skipped' && '⏭️' || '❌' }} |

                  > Plans are saved as artifacts and will be used for apply after merge.
                  EOF
