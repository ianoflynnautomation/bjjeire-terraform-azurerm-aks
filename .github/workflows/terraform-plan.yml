name: "Terraform Plan"

on:
    workflow_call:
        inputs:
            environment:
                type: string
                required: true
            terraform_version:
                type: string
                default: "1.9.8"
            working_directory:
                type: string
                default: "."
        secrets:
            AZURE_CLIENT_ID:
                required: true
            AZURE_TENANT_ID:
                required: true
            AZURE_SUBSCRIPTION_ID:
                required: true
            TF_VAR_gh_flux_aks_token:
                required: false
            TF_VAR_grafana_admin_password:
                required: false
        outputs:
            plan_exitcode:
                description: "Plan exit code (0=no changes, 2=changes)"
                value: ${{ jobs.plan.outputs.exitcode }}
            has_changes:
                description: "Whether plan has changes"
                value: ${{ jobs.plan.outputs.has_changes }}

permissions:
    id-token: write
    contents: read
    pull-requests: write

jobs:
    plan:
        name: Plan (${{ inputs.environment }})
        runs-on: ubuntu-latest
        environment: ${{ inputs.environment }}
        outputs:
            exitcode: ${{ steps.plan.outputs.exitcode }}
            has_changes: ${{ steps.check.outputs.has_changes }}
        env:
            TF_VAR_gh_flux_aks_token: ${{ secrets.GH_TOKEN_INFRA }}
            TF_VAR_grafana_admin_password: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
        steps:
            - name: Checkout
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.2

            - name: Setup Terraform & Azure
              uses: ./.github/actions/terraform-setup
              with:
                  terraform_version: ${{ inputs.terraform_version }}
                  azure_client_id: ${{ secrets.AZURE_CLIENT_ID }}
                  azure_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
                  azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
                  working_directory: ${{ inputs.working_directory }}
                  backend_config_file: environments/${{ inputs.environment }}/example.hcl

            - name: Terraform Plan
              id: plan
              working-directory: ${{ inputs.working_directory }}
              run: |
                  set +e
                  terraform plan \
                    -var-file=environments/${{ inputs.environment }}/example.tfvars \
                    -out=tfplan-${{ inputs.environment }} \
                    -detailed-exitcode \
                    -no-color \
                    2>&1 | tee plan_output.txt
                  EXITCODE=${PIPESTATUS[0]}
                  echo "exitcode=$EXITCODE" >> $GITHUB_OUTPUT
                  exit 0

            - name: Check for Changes
              id: check
              run: |
                  if [ "${{ steps.plan.outputs.exitcode }}" == "2" ]; then
                    echo "has_changes=true" >> $GITHUB_OUTPUT
                  else
                    echo "has_changes=false" >> $GITHUB_OUTPUT
                  fi

            - name: Upload Plan Artifact
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
              with:
                  name: tfplan-${{ inputs.environment }}-${{ github.sha }}
                  path: |
                      ${{ inputs.working_directory }}/tfplan-${{ inputs.environment }}
                      ${{ inputs.working_directory }}/plan_output.txt
                  retention-days: 5
                  if-no-files-found: error

            - name: Comment Plan on PR
              if: github.event_name == 'pull_request'
              uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
              with:
                  script: |
                      const fs = require('fs');
                      const plan = fs.readFileSync('${{ inputs.working_directory }}/plan_output.txt', 'utf8');
                      const maxLength = 60000;
                      const truncated = plan.length > maxLength 
                        ? plan.substring(0, maxLength) + '\n\n... (truncated)'
                        : plan;

                      const hasChanges = '${{ steps.check.outputs.has_changes }}' === 'true';
                      const status = hasChanges ? '⚠️ Changes Detected' : '✅ No Changes';

                      const body = `### Terraform Plan: \`${{ inputs.environment }}\` ${status}

                      <details><summary>Show Plan</summary>

                      \`\`\`hcl
                      ${truncated}
                      \`\`\`

                      </details>

                      *Commit: \`${{ github.sha }}\`*`;

                      // Find existing comment
                      const { data: comments } = await github.rest.issues.listComments({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.issue.number,
                      });

                      const botComment = comments.find(c => 
                        c.user.type === 'Bot' && 
                        c.body.includes(`Terraform Plan: \`${{ inputs.environment }}\``)
                      );

                      if (botComment) {
                        await github.rest.issues.updateComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          comment_id: botComment.id,
                          body: body
                        });
                      } else {
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                          body: body
                        });
                      }

            - name: Fail on Plan Error
              if: steps.plan.outputs.exitcode == '1'
              run: |
                  echo "::error::Terraform plan failed"
                  exit 1
