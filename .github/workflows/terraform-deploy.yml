name: "Terraform Deploy"

on:
    workflow_dispatch:
        inputs:
            environment:
                description: "Environment to deploy"
                required: true
                type: choice
                options:
                    - dev
                    - staging
                    - prod
            action:
                description: "Action to perform"
                required: true
                type: choice
                default: "apply"
                options:
                    - plan
                    - apply
            auto_approve:
                description: "Auto approve apply"
                required: false
                type: boolean
                default: true

permissions:
    id-token: write
    contents: read
    pull-requests: write
    actions: read

concurrency:
    group: deploy-${{ github.event.inputs.environment || 'auto-deploy' }}
    cancel-in-progress: false

env:
    TERRAFORM_VERSION: "1.9.8"
    TF_IN_AUTOMATION: "true"
    TF_INPUT: "false"

jobs:
    setup:
        name: Setup Deployment
        runs-on: ubuntu-latest
        outputs:
            environment: ${{ steps.config.outputs.environment }}
            action: ${{ steps.config.outputs.action }}
            auto_approve: ${{ steps.config.outputs.auto_approve }}
        steps:
            - name: Determine Configuration
              id: config
              run: |
                  if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                    echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
                    echo "action=${{ github.event.inputs.action }}" >> $GITHUB_OUTPUT
                    echo "auto_approve=${{ github.event.inputs.auto_approve }}" >> $GITHUB_OUTPUT
                  else
                    # Auto-deploy to dev on push to main
                    echo "environment=dev" >> $GITHUB_OUTPUT
                    echo "action=apply" >> $GITHUB_OUTPUT
                    echo "auto_approve=true" >> $GITHUB_OUTPUT
                  fi
    deploy-dev:
        name: Deploy (Dev)
        needs: setup
        if: needs.setup.outputs.environment == 'dev'
        runs-on: ubuntu-latest
        environment:
            name: dev
            url: https://portal.azure.com
        env:
            TF_VAR_gh_flux_aks_token: ${{ secrets.GH_TOKEN_INFRA }}
            TF_VAR_grafana_admin_password: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
        steps:
            - name: Checkout Repository
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

            - name: Setup Terraform with Azure Auth
              uses: ./.github/actions/terraform-setup
              with:
                  terraform_version: ${{ env.TERRAFORM_VERSION }}
                  azure_client_id: ${{ secrets.AZURE_CLIENT_ID }}
                  azure_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
                  azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
                  backend_config_file: environments/dev/backend.hcl

            - name: Terraform Plan
              id: plan
              run: |
                  terraform plan \
                  -var-file=environments/dev/terraform.tfvars \
                  -out=tfplan \
                  -detailed-exitcode
              continue-on-error: true

            - name: Check Plan Output
              id: plan-check
              run: |
                if [ "${{ steps.plan.outcome }}" == "failure" ]; then
                    echo "Plan failed"
                    exit 1
                fi
                # Exit code 2 means changes detected
                if [ "${{ steps.plan.outputs.exitcode }}" == "2" ]; then
                    echo "changes=true" >> $GITHUB_OUTPUT
                else
                    echo "changes=false" >> $GITHUB_OUTPUT
                fi

            - name: Terraform Apply
              if: |
                needs.setup.outputs.action == 'apply' && 
                steps.plan-check.outputs.changes == 'true'
              run: terraform apply -auto-approve tfplan

            - name: Output Deployment Info
              if: needs.setup.outputs.action == 'apply'
              run: |
                echo "## Deployment Summary (Dev)" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "| Output | Value |" >> $GITHUB_STEP_SUMMARY
                echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
                terraform output -json | jq -r 'to_entries[] | select(.value.sensitive != true) | "| \(.key) | \(.value.value // "N/A") |"' >> $GITHUB_STEP_SUMMARY
            
            
